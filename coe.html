<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CoE Dashboard - Summary View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e0f7fa, #e3f2fd, #f3e5f5);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      padding: 20px;
      border-radius: 16px;
      width: 100%;
      max-width: 1100px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    h1 {
      margin: 0;
      color: #1e40af;
      font-size: 26px;
      font-weight: 700;
    }

    .btn {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.2s ease;
    }
    .btn:hover {
      background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
      transform: scale(1.03);
    }

    .small { font-size: 13px; color: #555; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .dept-card, .year-card, .section-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid #e0e7ff;
    }

    .dept-card:hover, .year-card:hover, .section-card:hover {
      background: #eff6ff;
      transform: translateY(-4px);
    }

    h2, h3, h4 {
      color: #1e40af;
      margin-bottom: 6px;
    }

    label {
      font-size: 14px;
      font-weight: 500;
    }

    input[type="date"], select {
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #fff;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
        align-items: stretch;
      }

      .card {
        padding: 15px;
        border-radius: 12px;
      }

      .btn {
        padding: 8px 10px;
        font-size: 13px;
      }

      h1 { font-size: 22px; }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .dept-card, .year-card, .section-card {
        padding: 14px;
      }
    }
  </style>
</head>
<body onload="initCoEDashboard()">

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
    <div>
      <h1>CoE Dashboard</h1>
      <div id="welcome" class="small"></div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      <button class="btn" onclick="window.location.href='report.html'">Go to Reports</button>
      <button class="btn" onclick="window.location.href='lock.html'">Lock Editing</button>
      <button class="btn" onclick="window.location.href='upload.html'">Upload Users</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>
  <hr>

  <section>
    <div style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
      <label>Date:</label>
      <input type="date" id="filterDate">

      <label>Batch:</label>
      <select id="filterBatch">
        <option value="">--Select--</option>
        <option value="FN">FN</option>
        <option value="AN">AN</option>
      </select>

      <button class="btn" onclick="loadSummary()">View Summary</button>
      <button class="btn" onclick="downloadCSV()">Download CSV</button>
    </div>
    <div id="summaryArea"></div>
  </section>
</div>

<script>
let user = null;

function initCoEDashboard(){
  user = requireRole('CoE');
  if(!user) return;
  document.getElementById('welcome').innerText = `Signed in as: ${user.name}`;
}

async function loadSummary(){
  const date = document.getElementById('filterDate').value;
  const batch = document.getElementById('filterBatch').value;
  if(!date){ alert('Select a date'); return; }
  if(!batch){ alert('Select FN/AN'); return; }

  const res = await apiFetch({ action:'report', date, batch });
  if(!res.success){ document.getElementById('summaryArea').innerHTML = '<div class="small">No data</div>'; return; }

  renderDeptSummary(res.deptSummary);
}

function renderDeptSummary(ds){
  const area = document.getElementById('summaryArea');
  if(!ds){ area.innerHTML='<div class="small">No data</div>'; return; }

  let html = `<h2>Department-wise Summary</h2><div class="grid">`;
  for (const dept of Object.keys(ds).sort()) {
    const d = ds[dept];
    const pct = d.total === 0 ? 0 : Math.round((d.present / d.total) * 10000) / 100;
    html += `<div class="dept-card" onclick="drillDept('${encodeURIComponent(dept)}')">
      <h3>${dept}</h3>
      <p>Total: ${d.total}</p>
      <p>Present: ${d.present}</p>
      <p>Absent: ${d.absent}</p>
      <p>OD: ${d.od}</p>
      <p><b>Attendance: ${pct}%</b></p>
    </div>`;
  }
  html += '</div>';
  area.innerHTML = html;
}

async function drillDept(deptEnc){
  const dept = decodeURIComponent(deptEnc);
  const date = document.getElementById('filterDate').value;
  const batch = document.getElementById('filterBatch').value;
  const res = await apiFetch({ action:'report', department: dept, date, batch });
  if(!res.success) return;

  const deptSummary = res.deptSummary && res.deptSummary[dept];
  const years = Object.keys(deptSummary.years || {}).sort();
  let html = `<h3>${dept} - Year Summary</h3><div class="grid">`;

  for (const yr of years){
    const Y = deptSummary.years[yr];
    const pct = Math.round((Y.present / Y.total) * 10000)/100;
    html += `<div class="year-card" onclick="drillYear('${deptEnc}','${encodeURIComponent(yr)}')">
      <h4>Year: ${yr}</h4>
      <p>Total: ${Y.total}</p>
      <p>Present: ${Y.present}</p>
      <p>Absent: ${Y.absent}</p>
      <p>OD: ${Y.od}</p>
      <p><b>${pct}%</b></p>
    </div>`;
  }
  html += `</div><p><button class="btn" onclick="loadSummary()">Back</button></p>`;
  document.getElementById('summaryArea').innerHTML = html;
}

async function drillYear(deptEnc, yearEnc){
  const dept = decodeURIComponent(deptEnc);
  const year = decodeURIComponent(yearEnc);
  const date = document.getElementById('filterDate').value;
  const batch = document.getElementById('filterBatch').value;
  const res = await apiFetch({ action:'report', department: dept, date, batch });
  if(!res.success) return;

  const deptSummary = res.deptSummary && res.deptSummary[dept];
  const sections = deptSummary.years[year]?.sections || {};
  let html = `<h3>${dept} - Year ${year} Section Summary</h3><div class="grid">`;

  for (const sec of Object.keys(sections).sort()){
    const S = sections[sec];
    const pct = Math.round((S.present / S.total) * 10000)/100;
    html += `<div class="section-card">
      <h4>Section: ${sec}</h4>
      <p>Total: ${S.total}</p>
      <p>Present: ${S.present}</p>
      <p>Absent: ${S.absent}</p>
      <p>OD: ${S.od}</p>
      <p><b>${pct}%</b></p>
    </div>`;
  }
  html += `</div><p><button class="btn" onclick="drillDept('${deptEnc}')">Back</button></p>`;
  document.getElementById('summaryArea').innerHTML = html;
}

async function downloadCSV(){
  const date = document.getElementById('filterDate').value;
  const batch = document.getElementById('filterBatch').value;
  if(!date){ alert('Select a date first'); return; }
  if(!batch){ alert('Select FN/AN'); return; }

  const res = await apiFetch({ action:'report', date, batch });
  if(!res.success || !res.deptSummary){
    alert('No data to download');
    return;
  }

  const rows = [];
  rows.push(["Department","Year","Section","Total","Present","Absent","OD","Attendance %"]);

  for(const dept of Object.keys(res.deptSummary).sort()){
    const deptData = res.deptSummary[dept];
    const years = deptData.years || {};
    for(const year of Object.keys(years).sort()){
      const yearData = years[year];
      const sections = yearData.sections || {};
      for(const sec of Object.keys(sections).sort()){
        const S = sections[sec];
        const pct = S.total === 0 ? 0 : Math.round((S.present / S.total) * 10000)/100;
        rows.push([dept, year, sec, S.total, S.present, S.absent, S.od, pct]);
      }
    }
  }

  const csv = rows.map(r => r.map(s => `"${s}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `CoE_Summary_${date}_${batch}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function logout() {
  localStorage.removeItem("user");
  location.href = "index.html";
}
</script>
</body>
</html>
