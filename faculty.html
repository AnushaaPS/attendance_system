<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Faculty Dashboard - Exam Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>



<style>
  /* === Global === */
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7f9fc, #eef3f9);
    color: #111;
  }

  h1, h2, h3, h4 {
    margin: 6px 0;
  }

  /* === Header === */
  header {
    background: linear-gradient(135deg, #2463eb, #4f83ff);
    color: #fff;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }

  header h1 {
    font-size: 1.6rem;
    margin: 0;
  }

  #welcome {
    font-size: 14px;
    color: #fff;
    opacity: 0.9;
  }

  .logout-btn {
    background: rgba(255,255,255,0.2);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    padding: 8px 14px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .logout-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.03);
  }

  /* === Card Container === */
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    margin: 16px auto;
    padding: 18px;
    max-width: 1100px;
    animation: fadeIn 0.5s ease;
  }

  /* === Utility === */
  .u-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }

  .btn {
    background: #2463eb;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
  }

  .btn:hover {
    background: #1e54c9;
    transform: scale(1.02);
  }

  .small {
    font-size: 13px;
    color: #666;
  }

  /* === Inputs & Selects === */
  input[type="file"],
  input[type="date"],
  select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    min-width: 120px;
  }

  /* === Table Wrapper for Horizontal Scroll === */
  .table-container {
    width: 100%;
    overflow-x: auto;
    margin-top: 12px;
    border-radius: 8px;
  }

  /* === Table === */
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }

  th {
    background: #f1f5ff;
    color: #333;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  th, td {
    padding: 10px 8px;
    border: 1px solid #e4e9f1;
    text-align: left;
    font-size: 14px;
    white-space: nowrap;
  }

  tr:nth-child(even) {
    background: #fafbfe;
  }

  tr:hover {
    background: #f0f5ff;
  }

  input[id^="reason_"] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px;
  }

  /* === Year Cards === */
  #yearCardArea {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 12px;
    margin-top: 8px;
  }

  #yearCardArea .card {
    background: linear-gradient(180deg, #ffffff, #f3f6ff);
    cursor: pointer;
    transition: all 0.25s;
  }

  #yearCardArea .card:hover {
    transform: scale(1.03);
    box-shadow: 0 8px 18px rgba(0,0,0,0.12);
  }

  #yearCardArea p {
    margin: 3px 0;
    font-size: 14px;
  }

  #yearCardArea h4 {
    color: #1e54c9;
  }

  /* === Responsive === */
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      text-align: center;
    }

    header h1 {
      font-size: 1.3rem;
    }

    .logout-btn {
      margin-top: 10px;
    }

    .u-row {
      flex-direction: column;
      align-items: stretch;
    }

    table {
      font-size: 12px;
      min-width: 600px;
    }

    th, td {
      padding: 6px;
    }

    .btn {
      width: 100%;
      text-align: center;
    }
  }

  /* === Animations === */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>

<body onload="initFaculty()">

  <header>
    <div>
      <h1>Faculty Dashboard</h1>
      <div id="welcome" class="small"></div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <div class="card">
    <div class="u-row" style="justify-content:space-between;align-items:center;margin-bottom:6px;">
      <button class="btn" onclick="downloadExcelTemplate()">ðŸ“„ Download Excel Template</button>
      <span class="small">Use this template to upload seating data</span>
    </div>

    <hr>

    <!-- Upload -->
    <section>
      <h2>ðŸ“¤ Upload Seating Excel</h2>
      <div class="u-row">
        <input type="file" id="excelFile" accept=".xlsx,.xls" />
        <button class="btn" id="btnUpload" onclick="uploadExcel()">Upload & Save</button>
        <span id="uploadMsg" class="small"></span>
      </div>
    </section>

    <hr>

  <h2>Download Hall Plan</h2>
  <label for="planDate">Select Date:</label>
  <input type="date" id="planDate" class="input" />

  <label for="planBatch">Select Batch:</label>
  <select id="planBatch" class="input">
    <option value="">-- Select --</option>
    <option value="FN">FN</option>
    <option value="AN">AN</option>
  </select>

  <label for="internalExam">Select Exam:</label>
<select id="internalExam" class="input">
  <option value="I">Internal Exam I</option>
  <option value="II">Internal Exam II</option>
</select>

  <button class="btn" onclick="downloadHallPlan()">Download Hall Plan PDF</button>


    <!-- Absentees & Summary -->
    <section>
      <h2>ðŸ§¾ Absentees & Summary</h2>
      <div class="u-row" style="margin-bottom:8px;">
        <label>Date:</label>
        <input type="date" id="dateFilter" />

        <label>Batch:</label>
        <select id="batchSelect">
          <option value="FN">FN</option>
          <option value="AN">AN</option>
        </select>

        <label>Department:</label>
        <select id="deptSelect"></select>

        <button class="btn" onclick="loadAbsentees()">Load</button>
        <button class="btn" onclick="downloadAbsenteesCSV()">Download CSV</button>
      </div>

      <div id="deptStats" style="margin-top:8px" class="small"></div>

      <div id="absenteesArea" class="table-container"></div>

      <h3 style="margin-top:14px">ðŸ“Š Year & Section Summary</h3>
      <div id="yearCardArea"></div>

      <div id="yearSummaryArea" class="table-container"></div>
      <button class = "btn" id="downloadYearSummary">Download Excel</button>
<div id="yearSummaryArea"></div>

    </section>
  </div>

<script>
let user = null;
let absentees = [];
let currentTotals = null;
let currentYearSummary = null;

function initFaculty(){
  user = requireRole('Faculty');
  if(!user) return;
  document.getElementById('welcome').innerText = `Signed in as: ${user.name} â€” Dept: ${user.department || ''}`;
  populateDepartments();
}

async function populateDepartments(){
  const sel = document.getElementById('deptSelect');
  sel.innerHTML = '';
  if(user.department){
    const op = document.createElement('option');
    op.value = user.department;
    op.textContent = user.department;
    sel.appendChild(op);
    sel.disabled = true;   // âœ… faculty cannot change department
  }
}

function downloadExcelTemplate(){
  const headers = ["Date","Department","Batch","Hall No","Student Roll No","Name","Seating No","Subject Code","Subject","Year","Section"];
  const wb = XLSX.utils.book_new();
  const ws_data = [headers]; // only headers, empty rows
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  
  // Optional: set column widths for readability
  ws['!cols'] = [
    {wch:12},{wch:15},{wch:10},{wch:18},{wch:20},{wch:12},{wch:15},{wch:20},{wch:8},{wch:8},{wch:10},{wch:20}
  ];

  XLSX.utils.book_append_sheet(wb, ws, "SeatingTemplate");
  XLSX.writeFile(wb, "Faculty_Seating_Template.xlsx");
}

async function uploadExcel(){
  const f = document.getElementById('excelFile').files[0];
  const msg = document.getElementById('uploadMsg'); msg.textContent='';
  if(!f){ msg.textContent='Choose a file'; return; }
  document.getElementById('btnUpload').disabled = true; msg.textContent='Parsing...';
  try {
    const data = await f.arrayBuffer();
    const wb = XLSX.read(data,{type:'array'});
    const sname = wb.SheetNames[0];
    const sheet = wb.Sheets[sname];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
    if(!rows.length){ msg.textContent='No rows'; document.getElementById('btnUpload').disabled=false; return; }
    const normalized = rows.map(r=>({
      Date: r['Date'] || r['date'] || r['DATE'] || '',
      Department: r['Department'] || r['department'] || '',
      "Batch": r['Batch'] || '',
      "Hall No": r['Hall No'] || r['Hall'] || r['HallNo'] || '',
      "Student Roll No": r['Student Roll No'] || r['Roll No'] || r['RollNo'] || '',
      "Name": r['Name'] || r['name'] || '',
      "Seating No": r['Seating No'] || r['Seat No'] || r['SeatNo'] || '',
      "Subject Code": r['Subject Code'] || r['SubjectCode'] || '',
      Subject: r['Subject'] || r['Subject Name'] || '',
      "Year": r['Year'] || '',
      "Section": r['Section'] || ''
    }));
    const res = await apiFetch({ action:'uploadSeating', rows: normalized });
    if(res.success) msg.textContent = `Uploaded`;
    else msg.textContent = 'Upload failed: ' + (res.message||JSON.stringify(res));
  } catch(err){ console.error(err); msg.textContent = 'Error: '+err.message; }
  finally{ document.getElementById('btnUpload').disabled=false; }
}

async function loadAbsentees(){
  const dept = document.getElementById('deptSelect').value || user.department;
  const date = document.getElementById('dateFilter').value || '';
  const batch = document.getElementById('batchSelect').value || '';
  const res = await apiFetch({ action:'getAbsentees', department: dept, date, batch });

  document.getElementById('absenteesArea').innerHTML = '<div class="small">Loading...</div>';
  if(!res.success){ document.getElementById('absenteesArea').innerHTML = 'Error: '+(res.message||''); return; }
  absentees = res.absentees || [];
  currentTotals = res.totals || null;
  currentYearSummary = res.yearSummary || null;
  renderAbsentees();
  renderTotals();
  renderYearSummary();
}

function renderAbsentees(){
  const area = document.getElementById('absenteesArea');
  // accept rows already returned by backend; but be defensive about status text
  const filtered = (absentees || []).filter(r => {
    const s = (r.Status || "").toString().trim().toUpperCase();
    return s === "ABSENT" || s === "OD";
  });

  if(!filtered.length){
    area.innerHTML = '<div class="small">No absentees / OD entries</div>';
    return;
  }
  let html = '<table><thead><tr><th>Date</th><th>Hall</th><th>Seat</th><th>Roll</th><th>Name</th><th>Year</th><th>Section</th><th>Status</th><th>Reason</th><th>Action</th></tr></thead><tbody>';
  filtered.forEach((r, idx)=>{
    const reason = r.Reason||'';
    html += `<tr data-idx="${idx}">
      <td>${escapeHtml(r.Date||'')}</td>
      <td>${escapeHtml(r.HallNo||'')}</td>
      <td>${escapeHtml(r.SeatNo||'')}</td>
      <td>${escapeHtml(r.RollNo||'')}</td>
      <td>${escapeHtml(r.Name||'')}</td>
      <td>${escapeHtml(r.Year||'')}</td>
      <td>${escapeHtml(r.Section||'')}</td>
      <td>${escapeHtml(r.Status||'')}</td>
      <td><input id="reason_${idx}" value="${escapeHtml(reason)}" style="width:100%"></td>
      <td><button class="btn" onclick="saveReason(${idx})">Save</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  area.innerHTML = html;
}

function renderTotals(){
  const el = document.getElementById('deptStats');
  if(!currentTotals){ el.innerText=''; return; }
  el.innerHTML = `Total students: ${currentTotals.total} â€” Present: ${currentTotals.present} â€” Absent: ${currentTotals.absent} â€” OD: ${currentTotals.od} â€” Attendance: ${currentTotals.attendancePercent}%`;
}

function renderYearSummary(){
  const area = document.getElementById('yearSummaryArea');
  if(!currentYearSummary){ area.innerHTML=''; return; }
  // Build a table with Year / Section / total / present / absent / od / %
  let html = '<table><thead><tr><th>Year</th><th>Section</th><th>Total</th><th>Present</th><th>Absent</th><th>OD</th><th>Attendance %</th></tr></thead><tbody>';
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      html += `<tr><td>${escapeHtml(yr)}</td><td>${escapeHtml(sec)}</td><td>${s.total}</td><td>${s.present}</td><td>${s.absent}</td><td>${s.od}</td><td>${pct}%</td></tr>`;
    }
  }
  html += '</tbody></table>';
  area.innerHTML = html;
  // === Download Excel ===
document.getElementById('downloadYearSummary').addEventListener('click', () => {
  if(!currentYearSummary) { alert("No data to export"); return; }

  const ws_data = [["Year","Section","Total","Present","Absent","OD","Attendance %"]];
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      ws_data.push([yr, sec, s.total, s.present, s.absent, s.od, pct]);
    }
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Year Summary");
  XLSX.writeFile(wb, "YearSummary.xlsx");
});
}

async function saveReason(idx) {
  const r = absentees[idx];
  if (!r) return alert("Invalid record");

  // âœ… Always check lock status before allowing edit
  const lockRes = await apiFetch({ action: "getLockStatus", date: r.Date });
  if (lockRes.lock === "Locked") {
    alert(`Editing disabled â€” ${r.Date} is locked by CoE.`);
    // disable all save buttons + input boxes
    document.querySelectorAll("button.btn").forEach(b => {
      if (b.textContent === "Save") b.disabled = true;
    });
    document.querySelectorAll("input[id^='reason_']").forEach(i => (i.disabled = true));
    return;
  }

  const reason = document.getElementById("reason_" + idx).value;
  const res = await apiFetch({
    action: "saveReason",
    rollNo: r.RollNo,
    reason,
    date: r.Date,
    role: user.role
  });

  if (res.success) {
    alert("Saved successfully");
    absentees[idx].Reason = reason;
  } else {
    alert("Save failed: " + (res.message || ""));
  }
}

function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"'`]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]); }

function downloadAbsenteesCSV(){
  if(!absentees.length){ alert('No data'); return; }

  const batch = document.getElementById('batchSelect').value || '';
  const hdr = ["Date","Batch","Department","HallNo","SeatNo","RollNo","Name","Year","Section","Status","Reason"];
  const rows = absentees.map(r => [
    r.Date, batch, r.Department, r.HallNo, r.SeatNo, r.RollNo, r.Name || "", r.Year || "", r.Section || "", r.Status, r.Reason || ""
  ]);

  const csv = [hdr.join(","), ...rows.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(","))].join("\n");
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`absentees_${batch}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}


// Add this at the end of your <script> (after renderYearSummary)
function renderYearCards(){
  const area = document.getElementById('yearCardArea');
  if(!currentYearSummary){ area.innerHTML=''; return; }

  let html = '';
  for(const yr of Object.keys(currentYearSummary).sort()){
    const y = currentYearSummary[yr];
    for(const sec of Object.keys(y.sections).sort()){
      const s = y.sections[sec];
      const pct = s.total===0?0:Math.round((s.present / s.total)*10000)/100;
      html += `<div class="card" style="cursor:pointer;transition:0.2s;background:#f7f9fc;" onclick="viewSection('${yr}','${sec}')">
        <h4>Year: ${escapeHtml(yr)}, Section: ${escapeHtml(sec)}</h4>
        <p>Total: ${s.total}</p>
        <p>Present: ${s.present}</p>
        <p>Absent: ${s.absent}</p>
        <p>OD: ${s.od}</p>
        <p><b>Attendance: ${pct}%</b></p>
      </div>`;
    }
  }
  area.innerHTML = html;
}

// Modify your loadAbsentees() to also call renderYearCards
async function loadAbsentees(){
  const dept = document.getElementById('deptSelect').value || user.department;
  const date = document.getElementById('dateFilter').value || '';
  document.getElementById('absenteesArea').innerHTML = '<div class="small">Loading...</div>';
  const res = await apiFetch({ action:'getAbsentees', department: dept, date });
  if(!res.success){ document.getElementById('absenteesArea').innerHTML = 'Error: '+(res.message||''); return; }
  absentees = res.absentees || [];
  currentTotals = res.totals || null;
  currentYearSummary = res.yearSummary || null;
  renderAbsentees();
  renderTotals();
  renderYearSummary();
  renderYearCards(); // âœ… render grid cards
}

// Optional: add this function to handle clicking on a card
function viewSection(year, section){
  const rows = absentees.filter(r=>r.Year==year && r.Section==section);
  if(rows.length){
    renderAbsenteesTable(rows); // reuse table render for that section
  }
}

function renderAbsenteesTable(rows){
  const area = document.getElementById('absenteesArea');
  if(!rows.length){ area.innerHTML='<div class="small">No data</div>'; return; }
  let html = '<table><thead><tr><th>Date</th><th>Hall</th><th>Seat</th><th>Roll</th><th>Name</th><th>Year</th><th>Section</th><th>Status</th><th>Reason</th><th>Action</th></tr></thead><tbody>';
  rows.forEach((r, idx)=>{
    const reason = r.Reason||'';
    html += `<tr data-idx="${idx}">
      <td>${escapeHtml(r.Date||'')}</td>
      <td>${escapeHtml(r.HallNo||'')}</td>
      <td>${escapeHtml(r.SeatNo||'')}</td>
      <td>${escapeHtml(r.RollNo||'')}</td>
      <td>${escapeHtml(r.Name||'')}</td>
      <td>${escapeHtml(r.Year||'')}</td>
      <td>${escapeHtml(r.Section||'')}</td>
      <td>${escapeHtml(r.Status||'')}</td>
      <td><input id="reason_${idx}" value="${escapeHtml(reason)}" style="width:100%"></td>
      <td><button class="btn" onclick="saveReason(${idx})">Save</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  area.innerHTML = html;
}

function logout() {
      localStorage.removeItem("user");
      location.href = "index.html";
}
  
  // Replace existing downloadHallPlan() / generatePDF() with these
async function downloadHallPlan() {
  const selectedDate = document.getElementById("planDate").value;
  const selectedBatch = document.getElementById("planBatch").value;
  const selectedExam = document.getElementById("internalExam").value;

  if (!selectedDate || !selectedBatch || !selectedExam) {
    alert("Please select Date, Batch, and Internal Exam");
    return;
  }

  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || !user.department) {
    alert("Department information missing. Please login again.");
    return;
  }

  try {
    const res = await apiFetch({
      action: "getStudentSeatingData",
      date: selectedDate,
      batch: selectedBatch,
      department: user.department
    });

    let data = Array.isArray(res) ? res : res.success ? res.data : res.result;
    if (!data || data.length === 0) {
      alert("No seating data found for your department on this date and batch.");
      return;
    }

    // Pass department dynamically
    await generatePDF(data, selectedExam, user.department);
  } catch (err) {
    console.error("downloadHallPlan error:", err);
    alert("Error fetching hall plan: " + (err.message || err));
  }
}

async function generatePDF(data, examType, department) {
  if (!Array.isArray(data) || data.length === 0) {
    alert("No data to generate PDF.");
    return;
  }

  const departmentMap = {
    "CSE": "COMPUTER SCIENCE AND ENGINEERING",
    "ECE": "ELECTRONICS AND COMMUNICATION ENGINEERING",
    "ME": "MECHANICAL ENGINEERING",
    "CE": "CIVIL ENGINEERING",
    "ADS": "ARTIFICIAL INTELLIGENCE AND DATA SCIENCE"
  };

  const departmentFullName = departmentMap[department] || department.toUpperCase();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "pt", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const logoUrl = "logo.jpeg";

  const getField = (obj, names) => {
    for (const n of names) if (obj[n] !== undefined && obj[n] !== null) return obj[n];
    return "";
  };

  const firstSample = data[0] || {};
  const rawDateForFile = getField(firstSample, ["Date", "date"]) || "unknown";
  const dateObjForFile = new Date(rawDateForFile);
  const dateForName = `${dateObjForFile.getDate().toString().padStart(2,'0')}_${(dateObjForFile.getMonth()+1).toString().padStart(2,'0')}_${dateObjForFile.getFullYear()}`;
  const batchTextForName = getField(firstSample, ["Batch", "batch"]) || "Batch";

  const halls = [...new Set(data.map(row => getField(row, ["Hall No", "HallNo"])))].filter(Boolean);

  // Load logo
  let imgData = null;
  try {
    const resp = await fetch(logoUrl);
    if (resp.ok) {
      const blob = await resp.blob();
      const bitmap = await createImageBitmap(blob);
      const canvas = document.createElement("canvas");
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(bitmap, 0, 0);
      imgData = canvas.toDataURL("image/jpeg");
    }
  } catch(e) { console.warn("Logo load failed:", e); }

  for (let i = 0; i < halls.length; i++) {
    const hall = halls[i];
    const students = data.filter(r => getField(r, ["Hall No", "HallNo"]) == hall);

    if (i > 0) doc.addPage();

    // === Logo ===
    let y = 20;
    if (imgData) {
      const logoWidth = 250;
      const logoHeight = 50;
      doc.addImage(imgData, "JPEG", (pageWidth - logoWidth)/2, y, logoWidth, logoHeight);
      y += logoHeight + 30;
    }

    // === Headers ===
    doc.setFont("times", "bold");
    doc.setFontSize(16);
    const centerText = (txt, yPos) => doc.text(txt, pageWidth/2, yPos, { align: "center" });
    centerText("UNJHA V.DHANASAMY â€“ D.PARIMALA DEVI EXAMINATION CELL", y); y += 20;
    doc.setFontSize(12);
    centerText("Office of the Controller of Examinations", y); y += 18;
    centerText("ODD Semester of 2025 â€“ 2026", y); y += 18;
    centerText("HALL WISE SEATING ARRANGEMENT", y); y += 18;
    centerText(`DEPARTMENT OF ${departmentFullName}`, y); y += 18;
    centerText(`INTERNAL EXAMINATION â€“ ${examType}`, y); y += 25;

    // === Date / Session / Hall ===
    const sample = students[0] || data[0];
    const rawDate = getField(sample, ["Date", "date"]);
    const dateObj = new Date(rawDate);
    const dateStr = `${dateObj.getDate().toString().padStart(2,'0')}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getFullYear()}`;
    const batchText = getField(sample, ["Batch", "batch"]);

    doc.setFont("times", "normal");
    doc.setFontSize(12);
    doc.text(`Date: ${dateStr}`, 50, y);
    doc.text(`Session: ${batchText}`, pageWidth/2, y, { align: "center" });
    doc.text(`Hall: ${hall}`, pageWidth - 50, y, { align: "right" });
    y += 15;

    // === Seat Table ===
    const seatSeries = {};
    students.forEach(s => {
      const seatNo = getField(s, ["Seating No", "SeatNo", "Seat No"]);
      if (!seatNo) return;
      const series = seatNo.match(/^[A-Z]+/i)?.[0] || "?";
      if (!seatSeries[series]) seatSeries[series] = [];
      const seatNum = parseInt(seatNo.match(/\d+/)?.[0] || "0");
      seatSeries[series].push({
        seatNo,
        roll: getField(s, ["Student Roll No", "RollNo", "Roll No"]),
        seatNum,
        year: getField(s, ["Year", "year"]),
        section: getField(s, ["Section", "section"]),
        department: getField(s, ["Department", "Dept", "department"]),
        subject: getField(s, ["Subject Code", "SubjectCode", "Subject"])
      });
    });

    Object.keys(seatSeries).forEach(series => {
      seatSeries[series].sort((a, b) => a.seatNum - b.seatNum);
    });

    const maxRows = Math.max(...Object.values(seatSeries).map(arr => arr.length));
    const tableHeader = Object.keys(seatSeries).sort();
    const tableHeaderRow = [];
    for (let _ of tableHeader) tableHeaderRow.push("Seat No", "Roll No");

    const tableBody = [];
    for (let r = 0; r < maxRows; r++) {
      const row = [];
      for (const s of tableHeader) {
        const seat = seatSeries[s][r];
        row.push(seat ? seat.seatNo : "", seat ? seat.roll : "");
      }
      tableBody.push(row);
    }

    // === Column-wise year-section + count ===
    const maxSubRows = Math.max(
      ...Object.values(seatSeries).map(group => {
        const map = {};
        group.forEach(s => {
          const key = `${s.year || ""} ${s.section || ""}`.trim();
          map[key] = (map[key] || 0) + 1;
        });
        return Object.keys(map).length;
      })
    );

    for (let subRow = 0; subRow < maxSubRows; subRow++) {
      const row = [];
      for (const s of tableHeader) {
        const group = seatSeries[s];
        if (group && group.length > 0) {
          const map = {};
          group.forEach(st => {
            const key = `${st.year || ""} ${st.department || ""} ${st.section || ""}`.trim();
            map[key] = (map[key] || 0) + 1;
          });
          const entries = Object.entries(map);
          if (entries[subRow]) {
            const [yrsec, cnt] = entries[subRow];
            row.push(yrsec, cnt.toString());
          } else {
            row.push("", "");
          }
        } else {
          row.push("", "");
        }
      }
      tableBody.push(row);
    }

    // === Grand Total (bold) at last column ===
    const grandRow = new Array(tableHeader.length * 2).fill("");
    const lastSeatIndex = tableHeader.length * 2 - 2;
    grandRow[lastSeatIndex] = "Total";
    grandRow[lastSeatIndex + 1] = students.length.toString();
    tableBody.push(grandRow);

    // === Table ===
    doc.autoTable({
      head: [tableHeaderRow],
      body: tableBody,
      startY: y,
      theme: "grid",
      headStyles: { fillColor: [255, 255, 255], textColor: 0, lineColor: 0, lineWidth: 0.5, fontStyle: "bold" },
      styles: {
        font: "times",
        fontSize: 10,
        textColor: 0,
        halign: "center",
        valign: "middle",
        lineColor: 0,
        lineWidth: 0.5,
        fontStyle: "normal"
      },
      didParseCell: function (data) {
        // Bold all Roll Numbers and Grand Total
        if (data.cell.raw && (data.cell.raw.match(/^[0-9]{2}[A-Z]+[0-9]+$/i) || data.cell.raw === "Total" || data.cell.raw === students.length.toString())) {
          data.cell.styles.fontStyle = "bold";
        }
      },
      tableWidth: "auto",
      margin: { left: 40, right: 40 }
    });

    // === Subject Summary ===
    const subjectCounts = {};
    students.forEach(s => {
      const subj = getField(s, ["Subject Code", "SubjectCode", "Subject"]);
      if (subj) subjectCounts[subj] = (subjectCounts[subj] || 0) + 1;
    });

    let subjY = doc.lastAutoTable.finalY + 25;
    doc.setFont("times", "bold");
    doc.setFontSize(12);
    doc.text("Subject-wise Count:", 60, subjY);
    subjY += 25;

    doc.setFont("times", "normal");
    Object.entries(subjectCounts).forEach(([subj, count]) => {
      doc.text(`${subj} - ${count}`, 80, subjY);
      subjY += 14;
    });

    // === Footer ===
    doc.setFontSize(13);
    doc.text("Department Exam Cell In-charge", 90, pageHeight - 40);
    doc.text("HoD", pageWidth - 130, pageHeight - 40, { align: "right" });
  }

  doc.save(`HallPlan_${dateForName}_${batchTextForName}_Exam${examType}.pdf`);
}

</script>
</body>
</html>
