<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Users - CoE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="common.js"></script>
<style>
  /* Reset and Body */
  * { box-sizing: border-box; margin:0; padding:0; font-family: 'Arial', sans-serif; }
  body { background: #f0f4ff; color: #111; padding: 16px; }

  /* Container Card */
  .card { 
    background: #fff; 
    max-width: 900px; 
    margin: 30px auto; 
    padding: 20px 25px; 
    border-radius: 12px; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    transition: 0.3s ease;
  }

  .card:hover { box-shadow: 0 12px 25px rgba(0,0,0,0.12); }

  /* Header */
  .card-header {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media(min-width:600px){
    .card-header { flex-direction: row; justify-content: space-between; align-items: center; }
  }

  h1 { color: #2463eb; font-size: 1.8em; }
  .small { font-size: 0.85em; color: #666; }

  /* Buttons */
      .btn {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.2s ease;
    }
    .btn:hover {
      background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
      transform: scale(1.03);
    }

    .small { font-size: 13px; color: #555; }

  .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }

  /* File Upload */
  input[type=file] {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 100%;
    margin-top: 10px;
  }

  #uploadMsg { margin-top: 8px; font-size: 0.9em; color: #333; }

  /* Grid for departments/years/sections (if used) */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-top: 20px;
  }

  .dept-card, .year-card, .section-card {
    background: #f9faff;
    padding: 14px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    text-align: center;
    cursor: pointer;
    transition: 0.2s ease;
  }
  .dept-card:hover, .year-card:hover, .section-card:hover {
    background: #e2edff;
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  }

  /* Responsive Text & Tables */
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 8px 10px; border: 1px solid #ddd; text-align: left; }
  th { background: #2463eb; color: #fff; }

  @media(max-width:600px){
    h1 { font-size: 1.4em; }
    .btn { padding: 8px 12px; font-size: 0.9em; }
  }
</style>
</head>
<body>

<div class="card">
  <div class="card-header">
    <div>
      <h1>Users Upload</h1>
      <span id="welcome" class="small">Welcome, Admin</span>
    </div>
    <div class="btn-group">
      <button class="btn" onclick="window.location.href='coe.html'"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
      <button class="btn" onclick="window.location.href='lock.html'"><i class="fas fa-lock"></i> Lock</button>
      <button class="btn" onclick="window.location.href='report.html'"><i class="fas fa-file-alt"></i> Reports</button>
      <button class="btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <hr style="margin:15px 0; border:0.5px solid #ddd;">

  <div style="margin:12px 0">
    <button class="btn" onclick="downloadTemplate()"><i class="fas fa-download"></i> Download Excel Template</button>
    <span class="small">Use this template to upload user data</span>
  </div>

  <input type="file" id="excelFile" accept=".xlsx,.xls" />
  <button id="btnUpload" class="btn" onclick="uploadExcel()"><i class="fas fa-upload"></i> Upload & Save</button>
  <p id="uploadMsg" class="small"></p>

  <div id="reportTable"></div>
</div>

<script>
function downloadTemplate(){
  const headers = ["email","password","Name","Role","Department","Student Roll No"];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([headers]);
  XLSX.utils.book_append_sheet(wb, ws, "UsersTemplate");
  XLSX.writeFile(wb, "Users_Template.xlsx");
}

async function uploadExcel(){
  const file = document.getElementById("excelFile").files[0];
  const msg = document.getElementById("uploadMsg");
  msg.textContent = "";

  if (!file) { msg.textContent = "Choose a file"; return; }

  msg.textContent = "Reading Excel...";
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data, { type: "array" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

  if (!rows.length) { msg.textContent = "No rows found"; return; }

  const users = rows.map(r => ({
    email: r["email"],
    password: r["password"],
    name: r["Name"],
    role: r["Role"],
    department: r["Department"],
    studentRollNo: r["Student Roll No"]
  }));

  msg.textContent = "Parsing...";
  const res = await apiFetch({ action: "uploadUsersOverwrite", users });

  if (res.success)
    msg.textContent = `Uploaded ${res.count} users`;
  else
    msg.textContent = "Upload failed: " + (res.message || "Unknown error");
}

function logout() {
  localStorage.removeItem("user");
  location.href = "index.html";
}
</script>

</body>
</html>
