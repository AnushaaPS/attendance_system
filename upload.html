<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upload Users - CoE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="common.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; background: #f7f9fc; color: #111; }
    .card { background: #fff; padding: 18px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); max-width: 600px; margin: 50px auto; text-align: center; }
    .btn { background: #2463eb; color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; margin-top: 12px; }
    .small { font-size: 13px; color: #666; display: block; margin-top: 6px; }
    body { font-family: Arial; margin: 18px; background: #f7f9fc; }
    .card { background: #fff; padding: 18px; border-radius: 8px; max-width: 1100px; margin: 0 auto; box-shadow: 0 6px 18px rgba(0,0,0,0.05); }
    .btn { background: #2463eb; color: #fff; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; }
    .small { font-size: 13px; color: #666; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px; }
    .dept-card, .year-card, .section-card { 
      background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
      transition: 0.2s ease; cursor: pointer;
    }
    .dept-card:hover, .year-card:hover, .section-card:hover { background: #f0f6ff; transform: scale(1.02); }
    h2, h3, h4 { color: #2463eb; }
  </style>
</head>
<body>
    
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1>Users Upload</h1>
      <div id="welcome" class="small"></div>
    </div>
    <div>
      <button class="btn" onclick="window.location.href='coe.html'">Go to Dashboard</button>
      <button class="btn" onclick="window.location.href='lock.html'">Lock Editing</button>
      <button class="btn" onclick="window.location.href='report.html'">Go to Reports</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>
  <hr>

  <div style="margin:12px 0">
    <button class="btn" onclick="downloadTemplate()">Download Excel Template</button>
    <span class="small">Use this template to upload user data</span>
  </div>
  <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button id="btnUpload" class="btn" onclick="uploadExcel()">Upload & Save</button>
    <p id="uploadMsg" class="small"></p>
  <div id="reportTable" style="margin-top:20px;"></div>
</div>

<script>
function downloadTemplate(){
  const headers = ["email","password","Name","Role","Department","Student Roll No"];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([headers]);
  XLSX.utils.book_append_sheet(wb, ws, "UsersTemplate");
  XLSX.writeFile(wb, "Users_Template.xlsx");
}

async function uploadExcel(){
  const file = document.getElementById("excelFile").files[0];
  const msg = document.getElementById("uploadMsg");
  msg.textContent = "";

  if (!file) { msg.textContent = "Choose a file"; return; }

  msg.textContent = "Reading Excel...";
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data, { type: "array" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

  if (!rows.length) { msg.textContent = "No rows found"; return; }

  const users = rows.map(r => ({
    email: r["email"],
    password: r["password"],
    name: r["Name"],
    role: r["Role"],
    department: r["Department"],
    studentRollNo: r["Student Roll No"]
  }));

  msg.textContent = "Parsing...";
  const res = await apiFetch({ action: "uploadUsersOverwrite", users });

  if (res.success)
    msg.textContent = `Uploaded ${res.count} users`;
  else
    msg.textContent = "Upload failed: " + (res.message || "Unknown error");
}

  function logout() {
      localStorage.removeItem("user");
      location.href = "index.html";
}
  
</script>
</body>
</html>

